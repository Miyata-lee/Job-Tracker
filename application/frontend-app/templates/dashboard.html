<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JobTracker - Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ==== THEME (matches screenshot) ==== */
    :root{
      --bg1:#1e1e2e; --bg2:#2d2d44; --txt:#e0e0e0; --muted:#a78bfa;
      --brand:#38bdf8; --accent:#7c3aed;
      --applied:#60a5fa; --interview:#c084fc; --offer:#4ade80; --rejected:#f87171;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color:var(--txt);
      background: radial-gradient(1200px 600px at 50% -10%, rgba(56,189,248,.18), transparent 60%),
                  linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      min-height:100vh;
    }

    /* Top brand */
    .top{padding:28px 16px 0;text-align:center}
    .brand{
      display:flex;gap:12px;align-items:center;justify-content:center;
      font-size:40px;font-weight:800;color:var(--brand);
      text-shadow:0 8px 32px rgba(56,189,248,.45);
    }
    .sub{margin-top:6px;color:var(--muted);font-size:14px}

    /* Buttons */
    .actions{margin-top:14px;display:flex;gap:10px;justify-content:center;align-items:center}
    .btn{
      border:none;cursor:pointer;border-radius:12px;padding:10px 16px;
      font-weight:700;font-size:14px;transition:.25s;color:var(--txt);
      background:rgba(255,255,255,.04); border:1px solid rgba(124,58,237,.35);
      backdrop-filter:blur(6px)
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(124,58,237,.25)}
    .btn-ghost{background:transparent;color:var(--brand);border-color:rgba(56,189,248,.45)}
    .btn-primary{
      color:#fff;border-color:#1fb6ff;
      background:linear-gradient(135deg,#22d3ee 0%, #38bdf8 100%);
      box-shadow:0 14px 36px rgba(56,189,248,.38)
    }

    /* Container */
    .container{max-width:1160px;margin:24px auto 48px;padding:0 18px}

    /* Stat tiles */
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:18px 0 24px}
    .stat{
      border:2px solid transparent;border-radius:18px;padding:18px 16px;
      background:linear-gradient( rgba(30,30,46,.66), rgba(30,30,46,.66)) padding-box,
                 linear-gradient(135deg,#6b7280,#6b7280) border-box;
      display:flex;align-items:center;gap:14px; box-shadow:0 20px 50px rgba(0,0,0,.35)
    }
    .stat .icon{
      width:54px;height:54px;border-radius:14px;display:grid;place-items:center;
      font-size:20px;border:1px solid rgba(124,58,237,.35);
      background:rgba(124,58,237,.12);color:#c7afff
    }
    .stat .meta{flex:1}
    .stat .lbl{font-size:12px;letter-spacing:.6px;text-transform:uppercase;color:var(--muted)}
    .stat .val{font-size:28px;font-weight:800;margin-top:4px;color:#d4f0ff}

    /* Per‑tile gradients (order-based) */
    .stats .stat:nth-child(1){
      background:linear-gradient( rgba(30,30,46,.66), rgba(30,30,46,.66)) padding-box,
                 linear-gradient(135deg,#4f46e5,#7c3aed) border-box;
      box-shadow:0 14px 48px rgba(124,58,237,.25)
    }
    .stats .stat:nth-child(2){
      background:linear-gradient( rgba(30,30,46,.66), rgba(30,30,46,.66)) padding-box,
                 linear-gradient(135deg,#f472b6,#a855f7) border-box;
      box-shadow:0 14px 48px rgba(168,85,247,.25)
    }
    .stats .stat:nth-child(3){
      background:linear-gradient( rgba(30,30,46,.66), rgba(30,30,46,.66)) padding-box,
                 linear-gradient(135deg,#22d3ee,#60a5fa) border-box;
      box-shadow:0 14px 48px rgba(56,189,248,.25)
    }
    .stats .stat:nth-child(4){
      background:linear-gradient( rgba(30,30,46,.66), rgba(30,30,46,.66)) padding-box,
                 linear-gradient(135deg,#fb7185,#f472b6) border-box;
      box-shadow:0 14px 48px rgba(244,114,182,.25)
    }

    /* Search bar */
    .searchbar{
      display:flex;align-items:center;gap:10px;margin:6px 0 14px;
      background:#152038;border:2px solid rgba(56,189,248,.25);
      border-radius:14px;padding:14px 16px; box-shadow:inset 0 0 0 1px rgba(56,189,248,.08)
    }
    .searchbar i{color:#7ccdf4}
    .searchbar input{flex:1;background:transparent;border:none;outline:none;color:#dbeafe;font-size:15px}

    /* Filter chips */
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px}
    .chip{
      border:1px solid rgba(124,58,237,.35);background:transparent;color:#c7b7ff;
      padding:10px 16px;border-radius:999px;font-size:13px;font-weight:800;cursor:pointer;transition:.2s;
      display:flex;align-items:center;gap:8px
    }
    .chip:hover,.chip.active{
      background:#22d3ee;color:#0b1220;border-color:#22d3ee;
      box-shadow:0 10px 26px rgba(34,211,238,.35)
    }

    /* CTA and grid spacing (fix crowding) */
    .add-wrap{ display:flex;justify-content:center;margin:20px 0 22px }
    .add-wrap .btn-primary{padding:12px 18px;border-radius:12px}
    .grid{ display:grid; gap:16px }

    /* Cards */
    .card{
      background:linear-gradient(180deg, rgba(15,23,42,.85), rgba(16,18,34,.85));
      border:1px solid rgba(124,58,237,.35);border-radius:16px;
      padding:16px 18px 18px;
      box-shadow:0 16px 44px rgba(124,58,237,.18);transition:.2s;animation:rise .25s ease
    }
    @keyframes rise{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .card:hover{transform:translateY(-4px);border-color:#a78bfa}
    .card-top{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;margin-bottom:8px}
    .position{font-size:18px;font-weight:800;color:#7c3aed}
    .company{font-size:14px;color:var(--muted)}

    /* Status badges */
    .badge{padding:6px 12px;border-radius:999px;font-size:11px;font-weight:800;text-transform:uppercase}
    .b-applied{background:rgba(59,130,246,.18);color:var(--applied)}
    .b-interview{background:rgba(168,85,247,.18);color:var(--interview)}
    .b-offer{background:rgba(34,197,94,.18);color:var(--offer)}
    .b-rejected{background:rgba(239,68,68,.18);color:var(--rejected)}

    /* Facts row alignment (fix right spacing) */
    .facts{
      display:grid;
      grid-template-columns: 1fr auto;   /* left date, right company */
      column-gap:16px; row-gap:8px;
      align-items:center;
      margin:10px 0 12px;
    }
    .facts .fact:last-child{ justify-self:end }
    .fact{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px; line-height:1.25 }
    .fact i{ color:#7c3aed; width:18px; text-align:center }

    .notes{background:rgba(124,58,237,.08);border-left:3px solid #7c3aed;border-radius:8px;padding:10px;color:var(--muted);font-size:13px;margin-bottom:10px}
    .actions-row{display:flex;gap:10px;justify-content:flex-end}
    .btn-sm{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-size:12px;font-weight:700}
    .edit{background:#7c3aed;color:#fff}.edit:hover{background:#6d28d9}
    .del{background:#ef4444;color:#fff}.del:hover{background:#dc2626}

    .empty{text-align:center;color:var(--muted);padding:56px 18px}
    .empty i{font-size:44px;color:#7c3aed;margin-bottom:10px}

    /* Modal (shared styles) */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:50}
    .modal{position:fixed; inset:0; display:none; z-index:60; place-items:center; padding:18px}
    .modal.active,.modal-backdrop.active{display:grid}
    .modal-card{width:100%; max-width:720px; background:rgba(30,30,46,.95); border:1px solid #7c3aed; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.5); animation:rise .2s ease; padding:18px}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal-title{font-weight:800;color:#7c3aed}
    .x{background:transparent;border:1px solid rgba(124,58,237,.5);color:#a78bfa;border-radius:8px;padding:6px 10px;cursor:pointer}
    .field{margin-top:10px}
    .field label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    .field input,.field select,.field textarea{width:100%; padding:10px; background:rgba(30,30,46,.85); border:1px solid #7c3aed; border-radius:8px; color:var(--txt); font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.row{grid-template-columns:1fr}}
    .modal-actions{display:flex;gap:10px;margin-top:14px;justify-content:flex-end}
  </style>
</head>
<body>
  <!-- Top -->
  <div class="top">
    <div class="brand"><i class="fas fa-briefcase"></i> JobTracker</div>
    <div class="sub">Cloud‑Native Job Application Management System</div>
    <div class="actions">
      {% if username %}
        <span>Welcome, <strong id="username">{{ username }}</strong></span>
        <button class="btn btn-primary" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      {% else %}
        <a class="btn btn-ghost" href="/auth"><i class="fas fa-sign-in-alt"></i> Login</a>
        <a class="btn btn-primary" href="/auth"><i class="fas fa-user-plus"></i> Sign Up</a>
      {% endif %}
    </div>
  </div>

  <div class="container">
    <!-- Stats -->
    <div class="stats">
      <div class="stat"><div class="icon"><i class="fas fa-paper-plane"></i></div><div class="meta"><div class="lbl">Applied</div><div class="val" id="sApplied">0</div></div></div>
      <div class="stat"><div class="icon"><i class="fas fa-comments"></i></div><div class="meta"><div class="lbl">Interview</div><div class="val" id="sInterview">0</div></div></div>
      <div class="stat"><div class="icon"><i class="fas fa-handshake"></i></div><div class="meta"><div class="lbl">Offers</div><div class="val" id="sOffer">0</div></div></div>
      <div class="stat"><div class="icon"><i class="fas fa-xmark"></i></div><div class="meta"><div class="lbl">Rejected</div><div class="val" id="sRejected">0</div></div></div>
    </div>

    <!-- Search / filters -->
    <div class="searchbar"><i class="fas fa-magnifying-glass"></i><input id="searchInput" placeholder="Search by company or position..." onkeyup="filterJobs()"/></div>
    <div class="filters">
      <button class="chip active" data-status="all" onclick="filterByStatus(event,'all')"><i class="fas fa-layer-group"></i> All</button>
      <button class="chip" data-status="Applied" onclick="filterByStatus(event,'Applied')"><i class="fas fa-paper-plane"></i> Applied</button>
      <button class="chip" data-status="Interview" onclick="filterByStatus(event,'Interview')"><i class="fas fa-comments"></i> Interview</button>
      <button class="chip" data-status="Offer" onclick="filterByStatus(event,'Offer')"><i class="fas fa-handshake"></i> Offer</button>
      <button class="chip" data-status="Rejected" onclick="filterByStatus(event,'Rejected')"><i class="fas fa-xmark"></i> Rejected</button>
    </div>

    <!-- CTA -->
    <div class="add-wrap">
      <button class="btn btn-primary" onclick="openAddModal()"><i class="fas fa-plus"></i> Add New Job</button>
    </div>

    <!-- Jobs grid -->
    <div class="grid" id="jobsList">
      <div class="empty"><i class="fas fa-inbox"></i><p>No applications yet. Start by adding your first job application.</p></div>
    </div>
  </div>

  <!-- Add Job Modal -->
  <div id="modalBackdrop" class="modal-backdrop"></div>
  <div id="addJobModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle"><i class="fas fa-plus-circle"></i> Add New Application</div>
        <button class="x" onclick="closeAddModal()"><i class="fas fa-xmark"></i></button>
      </div>

      <form id="addJobForm" onsubmit="handleAddJob(event)">
        <div class="row">
          <div class="field"><label>Company Name</label><input id="company_name" required></div>
          <div class="field"><label>Position</label><input id="position" required></div>
        </div>

        <div class="row">
          <div class="field">
            <label>Status</label>
            <select id="status" required>
              <option>Applied</option><option>Interview</option><option>Offer</option><option>Rejected</option>
            </select>
          </div>
          <div class="field"><label>Date Applied</label><input type="date" id="date_applied" required></div>
        </div>

        <div class="field"><label>Notes</label><textarea id="notes" rows="3" placeholder="Any additional notes..."></textarea></div>

        <div class="modal-actions">
          <button type="button" class="btn" onclick="closeAddModal()"><i class="fas fa-ban"></i> Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Add Application</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Job Modal -->
  <div id="editModalBackdrop" class="modal-backdrop"></div>
  <div id="editJobModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="editModalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="editModalTitle"><i class="fas fa-pen"></i> Edit Application</div>
        <button class="x" onclick="closeEditModal()"><i class="fas fa-xmark"></i></button>
      </div>

      <form id="editJobForm" onsubmit="handleEditJob(event)">
        <input type="hidden" id="edit_id">
        <div class="row">
          <div class="field"><label>Company Name</label><input id="edit_company_name" required></div>
          <div class="field"><label>Position</label><input id="edit_position" required></div>
        </div>

        <div class="row">
          <div class="field">
            <label>Status</label>
            <select id="edit_status" required>
              <option>Applied</option><option>Interview</option><option>Offer</option><option>Rejected</option>
            </select>
          </div>
          <div class="field"><label>Date Applied</label><input type="date" id="edit_date_applied" required></div>
        </div>

        <div class="field"><label>Notes</label><textarea id="edit_notes" rows="3" placeholder="Any additional notes..."></textarea></div>

        <div class="modal-actions">
          <button type="button" class="btn" onclick="closeEditModal()"><i class="fas fa-ban"></i> Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="fas fa-floppy-disk"></i> Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Script A: modal controls -->
  <script>
    function openAddModal(){
      document.getElementById('addJobForm').reset();
      const d = document.getElementById('date_applied');
      if(d) d.valueAsDate = new Date();
      document.getElementById('modalBackdrop').classList.add('active');
      document.getElementById('addJobModal').classList.add('active');
      setTimeout(()=> document.getElementById('company_name').focus(), 50);
      document.addEventListener('keydown', escToClose);
    }
    function closeAddModal(){
      document.getElementById('modalBackdrop').classList.remove('active');
      document.getElementById('addJobModal').classList.remove('active');
      document.removeEventListener('keydown', escToClose);
    }
    function escToClose(e){ if(e.key==='Escape') closeAddModal(); }

    // Edit modal open/close
    async function openEditModal(id){
      try{
        const res = await fetch(`/api/jobs/${id}`);
        const data = await res.json();
        if(!data.success) return alert(data.message || 'Load failed');

        const j = data.job;
        document.getElementById('edit_id').value = j.id;
        document.getElementById('edit_company_name').value = j.company_name || '';
        document.getElementById('edit_position').value = j.position || '';
        document.getElementById('edit_status').value = j.status || 'Applied';
        document.getElementById('edit_date_applied').value = j.date_applied || '';
        document.getElementById('edit_notes').value = j.notes || '';

        document.getElementById('editModalBackdrop').classList.add('active');
        document.getElementById('editJobModal').classList.add('active');
        setTimeout(()=> document.getElementById('edit_company_name').focus(), 50);
        document.addEventListener('keydown', escToCloseEdit);
      }catch(_){
        alert('Network error');
      }
    }
    function closeEditModal(){
      document.getElementById('editModalBackdrop').classList.remove('active');
      document.getElementById('editJobModal').classList.remove('active');
      document.removeEventListener('keydown', escToCloseEdit);
    }
    function escToCloseEdit(e){ if(e.key==='Escape') closeEditModal(); }
  </script>

  <!-- Script B: jobs CRUD + filters + date-only rendering -->
  <script>
    let allJobs = []; let currentFilter = 'all';

    function fmtDateSafe(s){
      if(!s) return '';
      const opts = { day:'2-digit', month:'short', year:'numeric' };
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
        const [y,m,d] = s.split('-').map(Number);
        const dt = new Date(Date.UTC(y, m-1, d));
        return dt.toLocaleDateString(undefined, opts);
      }
      const dt = new Date(s);
      return isNaN(dt) ? s : dt.toLocaleDateString(undefined, opts);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const d = document.getElementById('date_applied'); if(d) d.valueAsDate = new Date();
      loadJobs(); loadStats();
    });

    async function loadJobs(){
      try{
        const res = await fetch('/api/jobs'); const data = await res.json();
        if(data.success){ allJobs = data.jobs||[]; renderJobs(allJobs); }
      }catch(_){ renderEmpty('Error loading jobs'); }
    }

    async function loadStats(){
      try{
        const res = await fetch('/api/stats'); const data = await res.json();
        if(data.success){
          const by = (data.by_status||[]).reduce((a,s)=>{a[s.status]=s.count;return a}, {});
          document.getElementById('sApplied').textContent = by['Applied']||0;
          document.getElementById('sInterview').textContent = by['Interview']||0;
          document.getElementById('sOffer').textContent = by['Offer']||0;
          document.getElementById('sRejected').textContent = by['Rejected']||0;
        }
      }catch(_){}
    }

    function renderJobs(list){
      const host = document.getElementById('jobsList');
      if(!list.length){ renderEmpty('No applications found'); return; }
      host.innerHTML = list.map(job=>{
        const chip = statusChip(job.status);
        return `
          <div class="card">
            <div class="card-top">
              <div>
                <div class="position">${escapeHtml(job.position)}</div>
                <div class="company">${escapeHtml(job.company_name)}</div>
              </div>
              <span class="badge ${chip.cls}">${chip.txt}</span>
            </div>
            <div class="facts">
              <div class="fact"><i class="fas fa-calendar"></i> ${fmtDateSafe(job.date_applied)}</div>
              <div class="fact"><i class="fas fa-briefcase"></i> ${escapeHtml(job.company_name)}</div>
            </div>
            ${job.notes ? `<div class="notes"><i class="fas fa-note-sticky"></i> ${escapeHtml(job.notes)}</div>` : ''}
            <div class="actions-row">
              <button class="btn-sm edit" onclick="openEditModal(${job.id})"><i class="fas fa-pen"></i> Edit</button>
              <button class="btn-sm del" onclick="deleteJob(${job.id})"><i class="fas fa-trash"></i> Delete</button>
            </div>
          </div>`;
      }).join('');
    }

    function renderEmpty(msg){
      document.getElementById('jobsList').innerHTML = `<div class="empty"><i class="fas fa-inbox"></i><p>${msg}</p></div>`;
    }

    function statusChip(status){
      const s=(status||'').toLowerCase();
      if(s==='applied') return {cls:'b-applied',txt:'APPLIED'};
      if(s==='interview') return {cls:'b-interview',txt:'INTERVIEW'};
      if(s==='offer') return {cls:'b-offer',txt:'OFFER'};
      if(s==='rejected') return {cls:'b-rejected',txt:'REJECTED'};
      return {cls:'b-applied',txt:status||'STATUS'};
    }

    async function handleAddJob(e){
      e.preventDefault();
      const payload = {
        company_name: document.getElementById('company_name').value.trim(),
        position: document.getElementById('position').value.trim(),
        status: document.getElementById('status').value,
        date_applied: document.getElementById('date_applied').value, // YYYY-MM-DD
        notes: document.getElementById('notes').value.trim()
      };
      try{
        const res = await fetch('/api/jobs',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const data = await res.json();
        if(data.success){ closeAddModal(); await loadJobs(); await loadStats(); }
        else{ alert(data.message||'Add failed'); }
      }catch(_){ alert('Network error'); }
    }

    async function deleteJob(id){
      if(!confirm('Delete this application?')) return;
      try{
        const res = await fetch(`/api/jobs/${id}`,{method:'DELETE'}); const data = await res.json();
        if(data.success){ await loadJobs(); await loadStats(); }
      }catch(_){ alert('Network error'); }
    }

    async function handleEditJob(e){
      e.preventDefault();
      const id = document.getElementById('edit_id').value;
      const payload = {
        company_name: document.getElementById('edit_company_name').value.trim(),
        position: document.getElementById('edit_position').value.trim(),
        status: document.getElementById('edit_status').value,
        date_applied: document.getElementById('edit_date_applied').value, // YYYY-MM-DD
        notes: document.getElementById('edit_notes').value.trim()
      };
      try{
        const res = await fetch(`/api/jobs/${id}`, {
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.success){
          closeEditModal();
          await loadJobs(); await loadStats();
        }else{
          alert(data.message || 'Update failed');
        }
      }catch(_){
        alert('Network error');
      }
    }

    function editJob(_id){ /* kept for legacy references, not used */ }

    function filterByStatus(ev,status){
      currentFilter = status;
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      ev.currentTarget.classList.add('active');
      filterJobs();
    }

    function filterJobs(){
      let filtered = [...allJobs];
      if(currentFilter!=='all') filtered = filtered.filter(j=>j.status===currentFilter);
      const q = document.getElementById('searchInput').value.toLowerCase();
      filtered = filtered.filter(j => j.company_name.toLowerCase().includes(q) || j.position.toLowerCase().includes(q));
      renderJobs(filtered);
    }

    async function handleLogout(){
      try{ await fetch('/api/logout',{method:'POST'}); location.href='/auth'; }
      catch(_){ alert('Logout error'); }
    }

    function escapeHtml(s){
      return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
  </script>
</body>
</html>
